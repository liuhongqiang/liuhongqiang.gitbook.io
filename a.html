<html>
<head>
<script src="agent.min.js"></script>
<script
  src="http://code.jquery.com/jquery-1.12.4.min.js"
  integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ="
  crossorigin="anonymous"></script>
<script>
(function(){
	var zipkinUrl = "http://localhost:9411/api/v2/spans";

	// js error
	window.addEventListener('error', function(event) { 
   		var message = event.message;
   		var filename = event.filename;
   		var lineno = event.lineno;
   		var colno = event.colno;
   		var href = event.target.location.href;
   		var userAgent = window.navigator.userAgent;
   		var tags = {
			message : event.message,
			filename : event.filename,
			lineno : event.lineno,
			colno : event.colno,
			href : window.location.href,
			userAgent : window.navigator.userAgent
		}
		sendToZipkin("ajaxError", this.responseURL, tags);
 	});

 	// ajax error
 	var wrapSend = function(originSend){
 		return function(){
 			var parm = arguments[0] || "";
 			this.addEventListener("readystatechange",function(){
 				var url  = this._runtime.url.toString();
 				if(url.startsWith(zipkinUrl)){
 					return;
 				}
 				if(this.readyState == 4 && this.status >= 400) {
 					try{
 						var tags = {
 							url : url,
				 			status : this.status,
				 			responseText : this.responseText,
				 			statusText : this.statusText,
				 			href : window.location.href,
				 			userAgent : window.navigator.userAgent
 						}
		 				sendToZipkin("ajaxError", this.responseURL, tags);
		 			} catch(e){}
 				}
 			});
 			try {
                return originSend.apply(this, arguments)
            } catch(p) {
                return Function.prototype.apply.call(originSend, this, arguments)
            }
 		};
 	};
 	var originSend = window.XMLHttpRequest.prototype.send;
 	window.XMLHttpRequest.prototype.send = wrapSend(originSend);

 	// send to zipkin
 	window.sendToZipkin = function(serviceName,name,tags){
 		var data = [
		    {
		      "traceId": new Date().getTime().toString() + Math.floor(Math.random() * 10000),
		      "id": new Date().getTime().toString() + Math.floor(Math.random() * 10000),
		      "name": name,
		      "kind": "PRODUCER",
		      "timestamp": new Date().getTime(),
		      "localEndpoint": {
		        "serviceName": serviceName
		      },
		      "tags": tags
		    }
		  ]
 		$.ajax({
		  "url": zipkinUrl,
		  "type":"POST",
		  "contentType":"application/json",
		  "data": JSON.stringify(data)
		});
 	}
})();

$.ajax({
  'url':'http://localhost:9411',
  'contentType':'application/json',
  'type':'POST',
  'data':'asd'
});


asdfasdfasdfasdf


</script>
</head>
<body>
asdasdf
</body>
</html>
